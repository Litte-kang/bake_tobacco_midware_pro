/*
Description			: use a module for calling other application.
Default value		: 0
The scope of value	:
First used			:
*/
var spawn = require('child_process').spawn;

/*
Description			: use 'eventss'.
Default value		: /
The scope of value	:
First used			:
*/
var events = require('events');

/*
Description			: get a event object.
Default value		: /
The scope of value	:
First used			:
*/
var event = new events.EventEmitter();

/*
Description			: handle timeout object, to stop clear setInterval().
Default value		: /
The scope of value	:
First used			:
*/
var timeoutObj;

/*
Description			: 0 - no download task, 1 - downloading.
Default value		: 0
The scope of value	:
First used			:
*/
var downloadStatus = 0; 

/*
Description			: bash shell directory
Default value		: /
The scope of value	:
First used			:
*/
var BASE_PATH = './node_modules/Fw/'

/***********************************************************************
**Function Name	: DownloadFw
**Description	: download fw from server.
**Parameters	: ResourcePath - download path
**Return		: none.
***********************************************************************/
function DownloadFw(ResourcePath)
{
	var get_src = spawn('/bin/bash', [BASE_PATH+'GET_SRC', ResourcePath]);

	downloadStatus = 1;
	
	console.log("downloading.....");
	
	timeoutObj = setTimeout(CheckNetworkStatus, 5000);
	
	get_src.once('close', function(code){
		
		if (0 === code)
		{
			console.log("download ok!");
						
			event.emit("download_end");
		}
		else
		{
			console.log("download failed!");
					
			event.emit("download_error", code);
		}
		
		downloadStatus = 0;	
	});
}

/***********************************************************************
**Function Name	: CheckNetworkStatus
**Description	: check network status, the packet loss is so bigger,
				: we will stop downloading.
**Parameters	: none.
**Return		: none.
***********************************************************************/
function CheckNetworkStatus()
{
	if (1 === GetDownloadStatus())
	{
		var check_net = spawn('/bin/bash', [BASE_PATH + 'CHECK_NET']);
		var is_stop_download = 0;
		
		check_net.stdout.once('data', function(data){
		
			console.log("Network status code:" + data[0]);
			
			if (49 === data[0])
			{
				is_stop_download = 1;
			}
		});
		
		check_net.once('close', function(code){
			
			if (1 === is_stop_download)
			{
				var kill = spawn('/bin/bash', [BASE_PATH + 'KILL']);
				
				console.log("network is bad, stop downloading");
				
				kill.once('close', function(code){
					
					console.log("stoped downloading");	
									
					clearTimeout(timeoutObj);
					
					downloadStatus = 0;
					
					event.emit("download_error", code);
				});				
			}
			
			timeoutObj = setTimeout(CheckNetworkStatus, 5000);
		});
	}
	else
	{
		console.log('stop check network');
		clearTimeout(timeoutObj);
		downloadStatus = 0;
	}
}

/***********************************************************************
**Function Name	: GetDownloadStatus
**Description	: get the current download status.
**Parameters	: none.
**Return		: the current download status.
***********************************************************************/
function GetDownloadStatus()
{
	return downloadStatus;
}

exports.DownloadFw = DownloadFw;
exports.GetDownloadStatus = GetDownloadStatus;
exports.Event = event;





